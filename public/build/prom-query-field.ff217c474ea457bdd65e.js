"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8325],{20065:(k,B,a)=>{a.d(B,{B:()=>l,a:()=>O});var F=a(56245);function l(p,h,d,y){if(!p)return!1;const E=D(h,y);if(!E.length)return!1;let s=E;if(p!==h){const i=D(p,y);s=E.flatMap(m=>i.filter(b=>m.text===b.text)||m)}return s.map(i=>_(p,d,i)).filter(v)}function D(p,h){const d=[];return h.parse(p).iterate({enter:E=>{if(E.type.id===F.Ql){const s=E.node;d.push({node:s,text:p.substring(s.from,s.to)})}}}),d}function _(p,h,d){if(h.length===1){const s=d.node.from===d.node.to,i=s&&d.node.parent?d.node.parent:d.node,m=s?p.substring(i.from,i.to):d.text;return{startLineNumber:1,startColumn:i.from+1,endLineNumber:1,endColumn:i.to+1,error:m}}let y=0,E=0;for(let s=0;s<h.length;s++){if(E=y+h[s].length,d.node.from>E){y+=h[s].length+1;continue}return{startLineNumber:s+1,startColumn:d.node.from-y+1,endLineNumber:s+1,endColumn:d.node.to-y+1,error:d.text}}return null}function v(p){return p!==null}const O={__interval:{text:"1s",value:"1s"},__rate_interval:{text:"1s",value:"1s"},__auto:{text:"1s",value:"1s"},__interval_ms:{text:"1000",value:1e3},__range_ms:{text:"1000",value:1e3},__range_s:{text:"1",value:1},__range:{text:"1s",value:"1s"}}},56245:(k,B,a)=>{a.d(B,{AA:()=>h,If:()=>p,Ql:()=>F,R1:()=>y,SY:()=>_,qk:()=>v,rq:()=>d,xz:()=>D,z9:()=>l});const F=0;function l(s){return s.firstChild?l(s.firstChild):s}function D(s,i){return{text:h(s,i),from:i.from,to:i.to,parentType:i.parent?.name}}const _=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::([^\}]+))?}/g;function v(s){return s.replace(_,(i,m,b,A,S,Y,G)=>{const U=A||G;let K=m,Q="0";return b&&(K=b,Q="1"),S&&(K=S,Q="2"),`__V_${Q}__`+K+"__V__"+(U?"__F__"+U+"__F__":"")})}const O=[(s,i)=>`$${s}`,(s,i)=>`[[${s}${i?`:${i}`:""}]]`,(s,i)=>`\${${s}${i?`:${i}`:""}}`];function p(s){return s.replace(/__V_(\d)__(.+?)__V__(?:__F__(\w+)__F__)?/g,(i,m,b,A)=>O[parseInt(m,10)](b,A))}function h(s,i){return i?p(s.substring(i.from,i.to)):""}function d(s,i,m,b){const A=[parseFloat(h(i,m))];return s.comparison&&A.push(b),{id:s.id,params:A}}function y(s,i,m){if(i.type.id===m||i.name===m)return[h(s,i)];const b=[];let A=0,S=i.childAfter(A);for(;S;)b.push(...y(s,S,m)),A=S.to,S=i.childAfter(A);return b}const E=s=>s.split(" ").map(m=>`${m}.*`).join("")},29049:(k,B,a)=>{a.r(B),a.d(B,{default:()=>We});var F=a(32196),l=a(21489),D=a(2543),_={id:"promql",extensions:[".promql"],aliases:["Prometheus","prometheus","prom","Prom","promql","Promql","promQL","PromQL"],mimetypes:[],loader:function(){return Promise.all([a.e(5807),a.e(5428)]).then(a.bind(a,86287))}},v=a(96540),O=a(39554),p=a(62938),h=a(13544),d=a(40845),y=a(85828),E=a(20065);function s(){const e=new Map;return e.set("expandSuggestionDocs",(!0).toString()),{onDidChangeValue:t=>{},onDidChangeTarget:t=>{},onWillSaveState:t=>{},get:(t,n,r)=>e.get(t)??r,getBoolean:(t,n,r)=>{const o=e.get(t);return o!==void 0?o==="true":r},getNumber:(t,n,r)=>{const o=e.get(t);return o!==void 0?parseInt(o,10):r},store:(t,n,r,o)=>{n==null?e.delete(t):e.set(t,n.toString())},remove:(t,n)=>{e.delete(t)},keys:(t,n)=>Array.from(e.keys()),logStorage:()=>{console.log("logStorage: not implemented")},migrate:()=>Promise.resolve(void 0),isNew:t=>!0,flush:t=>Promise.resolve(void 0)}}let i=null;function m(){return i===null&&(i={storageService:s()}),i}var b=a(45889),A=a(69470);class S extends Error{constructor(t){super("should never happen")}}async function Y(e){return(await e.getAllMetricNames()).map(n=>({type:"METRIC_NAME",label:n.name,insertText:n.name,detail:`${n.name} : ${n.type}`,documentation:n.help}))}const G=A.AW.map(e=>({type:"FUNCTION",label:e.label,insertText:e.insertText??"",detail:e.detail,documentation:e.documentation}));async function U(e){const t=await Y(e);return[...G,...t]}const K=["$__interval","$__range","$__rate_interval","1m","5m","10m","30m","1h","1d"].map(e=>({type:"DURATION",label:e,insertText:e}));async function Q(e){return(await e.getHistory()).slice(0,10).map(n=>({type:"HISTORY",label:n,insertText:n}))}function q(e,t){const n=[...t];return e!==void 0&&n.push({name:"__name__",value:e,op:"="}),`{${n.map(o=>`${o.name}${o.op}"${(0,b.Qn)(o.value)}"`).join(",")}}`}async function de(e,t,n){if(e===void 0&&t.length===0)return n.getAllLabelNames();{const r=q(e,t);return await n.getSeriesLabels(r,t)}}async function ee(e,t,n,r,o){return(await de(e,r,o)).map(c=>({type:"LABEL_NAME",label:c,insertText:`${c}${t}`,triggerOnInsert:n}))}async function fe(e,t,n){return ee(e,"=",!0,t,n)}async function ge(e,t,n){return ee(e,"",!1,t,n)}async function me(e,t,n,r){if(e===void 0&&n.length===0)return r.getLabelValues(t);{const o=q(e,n);return await r.getSeriesValues(t,o)}}async function pe(e,t,n,r,o){return(await me(e,t,r,o)).map(c=>({type:"LABEL_VALUE",label:c,insertText:n?c:`"${c}"`}))}async function he(e,t){switch(e.type){case"IN_DURATION":return K;case"IN_FUNCTION":return U(t);case"AT_ROOT":return U(t);case"EMPTY":{const n=await Y(t);return[...await Q(t),...G,...n]}case"IN_LABEL_SELECTOR_NO_LABEL_NAME":return fe(e.metricName,e.otherLabels,t);case"IN_GROUPING":return ge(e.metricName,e.otherLabels,t);case"IN_LABEL_SELECTOR_WITH_LABEL_NAME":return pe(e.metricName,e.labelName,e.betweenQuotes,e.otherLabels,t);default:throw new S(e)}}function Ce(e,t){switch(t){case"parent":return e.parent;case"firstChild":return e.firstChild;case"lastChild":return e.lastChild;case"nextSibling":return e.nextSibling;default:throw new S(t)}}function L(e,t){let n=e;for(const[r,o]of t)if(n=Ce(n,r),n===null||n.type.id!==o)return null;return n}function V(e,t){return t.slice(e.from,e.to)}function Ne(e){const t=e.slice(1,e.length-1);if(e.startsWith('"')&&e.endsWith('"'))return t.replace(/\\"/,'"');if(e.startsWith("'")&&e.endsWith("'"))return t.replace(/\\'/,"'");if(e.startsWith("`")&&e.endsWith("`"))return t;throw new Error("FIXME: invalid string literal")}function Le(e,t){return e.every((n,r)=>n===t[r])}const j=0,ve=[{path:[l.ww,l.Fb],fun:Oe},{path:[l.ab],fun:Te},{path:[l.Dh],fun:Ie},{path:[l.LW,l.BG],fun:ne},{path:[j,l.BG],fun:ne},{path:[j,l.l4],fun:_e},{path:[l.x$],fun:Se}],ye=new Map([[l.Hl,"="],[l.Ed,"=~"],[l.l3,"!="],[l.$i,"!~"]]);function Ee(e){const t=e.firstChild;return t===null?null:ye.get(t.type.id)??null}function be(e,t){if(e.type.id!==l.BG)return null;const n=L(e,[["firstChild",l.IC]]);if(n===null)return null;const r=L(n,[["nextSibling",l.Lf]]);if(r===null)return null;const o=Ee(r);if(o===null)return null;const u=L(e,[["lastChild",l.LW]]);if(u===null)return null;const c=V(n,t),C=Ne(V(u,t));return{name:c,value:C,op:o}}function te(e,t){if(e.type.id!==l.ww)return[];let n=L(e,[["firstChild",l.Uq]]);const r=[];for(;n!==null;){const o=L(n,[["lastChild",l.BG]]);if(o===null)return[];const u=be(o,t);u!==null&&r.push(u),n=L(n,[["firstChild",l.Uq]])}return r.reverse(),r}function Ae(e){let t=e.firstChild;const n=[];for(;t!==null;)n.push(t),t=t.nextSibling;return n}function X(e,t){if(e.type.id===t)return e;const n=Ae(e);for(const r of n){const o=X(r,t);if(o!==null)return o}return null}function Se(e,t,n){const r=L(e,[["parent",l.hI],["parent",l.Fn]]);if(r===null)return null;const o=r.getChild(l.Dh);if(o===null)return null;const u=X(o,l.iP);if(u===null)return null;const c=L(u,[["firstChild",l.gw]]);return c===null?null:{type:"IN_GROUPING",metricName:V(c,t),otherLabels:[]}}function ne(e,t,n){const r=!e.type.isError,o=L(e,[["parent",l.BG]]);if(o===null)return null;const u=L(o,[["firstChild",l.IC]]);if(u===null)return null;const c=V(u,t),C=L(o,[["parent",l.Uq]]);if(C===null)return null;let W=C,M=null;for(;M===null;){const N=W.parent;if(N===null)return null;const{id:H}=N.type;switch(H){case l.Uq:W=N;continue;case l.ww:M=N;continue;default:return null}}const T=te(M,t).filter(N=>N.name!==c),I=L(M,[["parent",l.Fb],["firstChild",l.iP],["firstChild",l.gw]]);return I===null?{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",labelName:c,betweenQuotes:r,otherLabels:T}:{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",metricName:V(I,t),labelName:c,betweenQuotes:r,otherLabels:T}}function Te(e,t,n){return{type:"AT_ROOT"}}function Ie(e,t,n){return{type:"IN_FUNCTION"}}function _e(e,t,n){return{type:"IN_DURATION"}}function Me(e){return X(e,j)!==null}function Oe(e,t,n){if(Me(e))return null;const r=L(e,[["firstChild",l.Uq]]);if(r!==null&&!t.slice(r.to,n).includes(","))return null;const o=L(e,[["parent",l.Fb],["firstChild",l.iP],["firstChild",l.gw]]),u=te(e,t);return o===null?{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",otherLabels:u}:{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",metricName:V(o,t),otherLabels:u}}function Re(e,t){const n=e.cursorAt(t);for(;;){if(n.from===t&&n.to===t){const{node:r}=n;if(r.type.isError)return r}if(!n.next())break}return null}function we(e,t){if(e==="")return{type:"EMPTY"};const n=l.K3.parse(e),r=Re(n,t),o=r!=null?r.cursor():n.cursorAt(t),u=o.node,c=[o.type.id];for(;o.parent();)c.push(o.type.id);for(let C of ve)if(Le(C.path,c))return C.fun(u,e,t);return null}function Pe(){return{showWords:!1}}function xe(e,t){switch(e){case"DURATION":return t.languages.CompletionItemKind.Unit;case"FUNCTION":return t.languages.CompletionItemKind.Variable;case"HISTORY":return t.languages.CompletionItemKind.Snippet;case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;case"METRIC_NAME":return t.languages.CompletionItemKind.Constructor;default:throw new S(e)}}function Be(e,t){return{triggerCharacters:["{",",","[","(","=","~"," ",'"'],provideCompletionItems:(r,o)=>{const u=r.getWordAtPosition(o),c=u!=null?e.Range.lift({startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:u.startColumn,endColumn:u.endColumn}):e.Range.fromPositions(o),C={column:o.column,lineNumber:o.lineNumber};if(window.getSelection){const T=window.getSelection()?.toString();T&&T.length>0&&(C.column=C.column-T.length)}const W=r.getOffsetAt(C),M=we(r.getValue(),W);return(M!=null?he(M,t):Promise.resolve([])).then(T=>{const I=T.length.toString().length;return{suggestions:T.map((N,H)=>({kind:xe(N.type,e),label:N.label,insertText:N.insertText,detail:N.detail,documentation:N.documentation,sortText:H.toString().padStart(I,"0"),range:c,command:N.triggerOnInsert?{id:"editor.action.triggerSuggest",title:""}:void 0}))}})}}}const Fe={codeLens:!1,contextmenu:!1,fixedOverflowWidgets:!0,folding:!1,fontSize:14,lineDecorationsWidth:8,lineNumbers:"off",minimap:{enabled:!1},overviewRulerBorder:!1,overviewRulerLanes:0,padding:{top:4,bottom:5},renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0,alwaysConsumeMouseWheel:!1},scrollBeyondLastLine:!1,suggest:Pe(),suggestFontSize:12,wordWrap:"on"},De=2,z=_.id;let re=!1;function $e(e){if(re===!1){re=!0;const{aliases:t,extensions:n,mimetypes:r,loader:o}=_;e.languages.register({id:z,aliases:t,extensions:n,mimetypes:r}),o().then(u=>{e.languages.setMonarchTokensProvider(z,u.language),e.languages.setLanguageConfiguration(z,u.languageConfiguration)})}}const Ve=(e,t)=>({container:(0,F.css)`
      border-radius: ${e.shape.radius.default};
      border: 1px solid ${e.components.input.borderColor};
    `,placeholder:(0,F.css)`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.6;
      }
    `}),We=e=>{const t=(0,p.A)(),n=(0,v.useRef)(m()),r=(0,v.useRef)(null),{languageProvider:o,history:u,onBlur:c,onRunQuery:C,initialValue:W,placeholder:M,onChange:J,datasource:T}=e,I=(0,O.A)(o),Z=(0,O.A)(u),N=(0,O.A)(C),H=(0,O.A)(c),Ue=(0,O.A)(J),oe=(0,v.useRef)(null),Ke=(0,d.$j)(),le=Ve(Ke,M);return(0,v.useEffect)(()=>()=>{oe.current?.()},[]),v.createElement("div",{"data-testid":h.Tp.components.QueryField.container,className:le.container,ref:r},v.createElement(y.m,{overrideServices:n.current,options:Fe,language:"promql",value:W,beforeMount:f=>{$e(f)},onMount:(f,R)=>{const se=f.createContextKey("isEditorFocused"+t,!1);f.onDidBlurEditorWidget(()=>{se.set(!1),H.current(f.getValue())}),f.onDidFocusEditorText(()=>{se.set(!0)});const Qe=()=>Promise.resolve(Z.current.map(g=>g.query.expr).filter(g=>g!==void 0)),He=()=>{const{metrics:g,metricsMetadata:w}=I.current,$=g.map(P=>{const x=w?.[P];return{name:P,help:x?.help??"",type:x?.type??""}});return Promise.resolve($)},Ge=()=>Promise.resolve(I.current.getLabelKeys()),ze=g=>I.current.getLabelValues(g),ke=I.current.getSeriesValues,Ye=I.current.getSeriesLabels,ie=Be(R,{getHistory:Qe,getAllMetricNames:He,getAllLabelNames:Ge,getLabelValues:ze,getSeriesValues:ke,getSeriesLabels:Ye}),je={...ie,provideCompletionItems:(g,w,$,P)=>f.getModel()?.id!==g.id?{suggestions:[]}:ie.provideCompletionItems(g,w,$,P)},{dispose:Xe}=R.languages.registerCompletionItemProvider(z,je);oe.current=Xe;const ae=()=>{const g=r.current;if(g!==null){const w=f.getContentHeight();g.style.height=`${w+De}px`,g.style.width="100%";const $=g.clientWidth;f.layout({width:$,height:w})}};f.onDidContentSizeChange(ae),ae();const Je=(0,D.debounce)(()=>{const g=f.getValue();Ue.current(g)},I.current.datasource.getDebounceTimeInMilliseconds());if(f.getModel()?.onDidChangeContent(()=>{Je()}),f.addCommand(R.KeyMod.Shift|R.KeyCode.Enter,()=>{N.current(f.getValue())},"isEditorFocused"+t),f.addCommand(R.KeyMod.CtrlCmd|R.KeyCode.KeyK,function(){a.g.dispatchEvent(new KeyboardEvent("keydown",{key:"k",metaKey:!0}))}),M){const g=[{range:new R.Range(1,1,1,1),options:{className:le.placeholder,isWholeLine:!0}}];let w=[];const $=()=>{const P=f.getModel();if(!P)return;const x=P.getValueLength()===0?g:[];w=P.deltaDecorations(w,x)};$(),f.onDidChangeModelContent($),f.onDidChangeModelContent(P=>{const x=f.getModel();if(!x)return;const ue=x.getValue(),Ze=((0,E.B)(ue,T.interpolateString(ue,E.a),x.getLinesContent(),l.K3)||[]).map(({error:ce,...qe})=>({message:`${ce?`Error parsing "${ce}"`:"Parse error"}. The query appears to be incorrect and could fail to be executed.`,severity:R.MarkerSeverity.Error,...qe}));R.editor.setModelMarkers(x,"owner",Ze)})}}}))}},39554:(k,B,a)=>{a.d(B,{A:()=>D});var F=a(96540),l=function(_){var v=(0,F.useRef)(_);return v.current=_,v};const D=l}}]);

//# sourceMappingURL=prom-query-field.ff217c474ea457bdd65e.js.map